-- ============================
-- Table storing scheduled jobs
-- ============================

CREATE TABLE "XACT_JOBS_JOB" (
  "ID" NUMBER(19) GENERATED BY DEFAULT ON NULL AS IDENTITY NOT NULL,
  "SCHEDULED_AT" TIMESTAMP NOT NULL,
  "QUEUE" NVARCHAR2(50) NOT NULL,
  "LEASED_UNTIL" TIMESTAMP,
  "LEASER" RAW(16),
  "TYPE_NAME" NVARCHAR2(2000) NOT NULL,
  "METHOD_NAME" NVARCHAR2(2000) NOT NULL,
  "METHOD_ARGS" NVARCHAR2(2000) NOT NULL,
  "PERIODIC_JOB_ID" NVARCHAR2(2000),
  "CRON_EXPRESSION" NVARCHAR2(2000),
  "ERROR_COUNT" NUMBER(10) NOT NULL,
  CONSTRAINT "PK_JOB" PRIMARY KEY ("QUEUE", "SCHEDULED_AT", "ID")
);

CREATE INDEX "IX_JOB_LEASER" ON "XACT_JOBS_JOB" ("LEASER");

-- ===============================
-- Table storing execution history
-- ===============================

CREATE TABLE "XACT_JOBS_JOB_HISTORY" (
  "ID" NUMBER(19) NOT NULL,
  "PROCESSED_AT" TIMESTAMP NOT NULL,
  "STATUS" NUMBER(10) NOT NULL,
  "ERROR_MESSAGE" NVARCHAR2(2000),
  "ERROR_STACK_TRACE" NVARCHAR2(2000),
  "SCHEDULED_AT" TIMESTAMP NOT NULL,
  "TYPE_NAME" NVARCHAR2(2000) NOT NULL,
  "METHOD_NAME" NVARCHAR2(2000) NOT NULL,
  "METHOD_ARGS" NVARCHAR2(2000) NOT NULL,
  "QUEUE" NVARCHAR2(2000) NOT NULL,
  "PERIODIC_JOB_ID" NVARCHAR2(2000),
  "CRON_EXPRESSION" NVARCHAR2(2000),
  "ERROR_COUNT" NUMBER(10) NOT NULL,
  CONSTRAINT "PK_JOB_HISTORY" PRIMARY KEY ("ID", "PROCESSED_AT")
);

CREATE INDEX "IX_JOB_HISTORY_PROCESSED_AT" ON "XACT_JOBS_JOB_HISTORY" ("PROCESSED_AT");

-- ============================
-- Table storing recurring jobs
-- ============================

CREATE TABLE "XACT_JOBS_JOB_PERIODIC" (
  "ID" NVARCHAR2(450) NOT NULL,
  "CREATED_AT" TIMESTAMP NOT NULL,
  "UPDATED_AT" TIMESTAMP NOT NULL,
  "CRON_EXPRESSION" NVARCHAR2(2000) NOT NULL,
  "TYPE_NAME" NVARCHAR2(2000) NOT NULL,
  "METHOD_NAME" NVARCHAR2(2000) NOT NULL,
  "METHOD_ARGS" NVARCHAR2(2000) NOT NULL,
  "QUEUE" NVARCHAR2(2000) NOT NULL,
  "IS_ACTIVE" NUMBER(1) NOT NULL,
  CONSTRAINT "PK_JOB_PERIODIC" PRIMARY KEY ("ID")
);
